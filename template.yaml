job_name: JOB-NAME

device_type: DEVICE-NAME

visibility: public

priority: high

context:
  test_character_delay: 10

timeouts:
  action:
    minutes: 10
  actions:
    power-off:
      seconds: 30
  job:
    minutes: 30
  queue:
    days: 2

metadata:
  node_id: NODE-ID
  api_config_name: staging
  storage_config_name: staging-azure

actions:
- deploy:
    dtb:
      url: https://storage.chromeos.kernelci.org/images/kernel/v6.1-mediatek/dtbs/mediatek/DEVICE-NAME.dtb
    kernel:
      url: https://storage.chromeos.kernelci.org/images/kernel/v6.1-mediatek/kernel/Image
    modules:
      compression: xz
      url: https://storage.chromeos.kernelci.org/images/kernel/v6.1-mediatek/modules.tar.xz
    namespace: modules
    nfsrootfs:
      compression: xz
      url: https://storage.chromeos.kernelci.org/images/rootfs/debian/bookworm-cros-flash/20240422.0/arm64/full.rootfs.tar.xz
    os: oe
    ramdisk:
      compression: gz
      url: https://storage.chromeos.kernelci.org/images/rootfs/debian/bookworm-cros-flash/20240422.0/arm64/initrd.cpio.gz
    timeout:
      minutes: 10
    to: tftp
- boot:
    commands: nfs
    namespace: modules
    method: depthcharge
    failure_retry: 3
    prompts:
    - '/ #'
    timeout:
      minutes: 10
    timeouts:
      bootloader-commands:
        minutes: 3
      auto-login-action:
        minutes: 2

- test:
    namespace: modules
    timeout:
      minutes: 5
    definitions:
    - repository:
        metadata:
          format: Lava-Test Test Definition 1.0
          name: modules
          description: modules
          os:
            - oe
          scope:
            - functional
          environment:
            - lava-test-shell
        run:
          steps:
          - /opt/chromeos/install-modules 'https://kciapistagingstorage1.file.core.windows.net/early-access/kbuild-gcc-12-arm64-chromeos-mediatek-66995b6baa07c494f8d68b19/modules.tar.xz?sv=2022-11-02&ss=f&srt=sco&sp=r&se=2024-10-17T19:19:12Z&st=2023-10-17T11:19:12Z&spr=https&sig=sLmFlvZHXRrZsSGubsDUIvTiv%2BtzgDq6vALfkrtWnv8%3D'
            || lava-test-raise "modules-install"
      from: inline
      name: modules
      path: inline/modules.yaml

- deploy:
    dtb:
      url: https://kciapistagingstorage1.file.core.windows.net/early-access/kbuild-gcc-12-arm64-chromeos-mediatek-66995b6baa07c494f8d68b19/dtbs/mediatek/mt8195-cherry-tomato-r2.dtb?sv=2022-11-02&ss=f&srt=sco&sp=r&se=2024-10-17T19:19:12Z&st=2023-10-17T11:19:12Z&spr=https&sig=sLmFlvZHXRrZsSGubsDUIvTiv%2BtzgDq6vALfkrtWnv8%3D
    kernel:
      url: https://kciapistagingstorage1.file.core.windows.net/early-access/kbuild-gcc-12-arm64-chromeos-mediatek-66995b6baa07c494f8d68b19/Image?sv=2022-11-02&ss=f&srt=sco&sp=r&se=2024-10-17T19:19:12Z&st=2023-10-17T11:19:12Z&spr=https&sig=sLmFlvZHXRrZsSGubsDUIvTiv%2BtzgDq6vALfkrtWnv8%3D
    namespace: chromeos
    os: oe
    timeout:
      minutes: 10
    to: tftp

- boot:
    namespace: chromeos
    timeout:
      minutes: 10
    timeouts:
      bootloader-commands:
        minutes: 3
      auto-login-action:
        minutes: 2
    failure_retry: 3
    method: depthcharge
    commands: emmc
    extra_kernel_args: cros_secure cros_debug root=PARTUUID=566f7961-6765-7220-746f-20756e697665 rootwait ro
    prompts:
      - 'localhost(.*)~(.*)#'
    failure_message: 'chromeos-boot-alert: self_repair'
    auto_login:
      login_prompt: "login:"
      username: "root"
      password_prompt: "Password:"
      password: "test0000"

- test:
    namespace: chromeos
    timeout:
      minutes: 30
    docker:
      image: kernelci/cros-tast
      wait:
        device: true
    results:
      location: /home/cros/lava
    definitions:
    - from: inline
      name: v4l2-test
      path: inline/v4l2-test.yaml
      repository:
        metadata:
          format: Lava-Test Test Definition 1.0
          name: cros-tast
        run:
          steps:
            - cd /home/cros
            - lava-test-set start setup
            - lava-test-case tast-tarball --shell curl -s 'https://storage.chromeos.kernelci.org/images/rootfs/chromeos/chromiumos-cherry/20240514.0/arm64/tast.tgz'
              \| tar xzvf - && cp remote_test_runner /usr/bin/remote_test_runner &&
              mkdir -p /usr/libexec/tast/bundles/remote/ && cp cros /usr/libexec/tast/bundles/remote/
            - for i in $(seq 1 60); do ping -c 1 -w 1 $(lava-target-ip) && break || sleep 1; done
            - ping -c 1 -w 1 $(lava-target-ip) || lava-test-raise "cros-device-unreachable"
            - ./ssh_retry.sh
              -o StrictHostKeyChecking=no
              -o UserKnownHostsFile=/dev/null
              -i /home/cros/.ssh/id_rsa
              root@$(lava-target-ip)
              python3 /usr/bin/fluster_parser.py -ts TESTSUITE -d DECODERS